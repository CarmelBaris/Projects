---
title: "Lab Task 5"
author: "Group 6"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output: html_document
---

## Group members:
Shawn Yakir , 315714980, shawnyakir@gmail.com  
Sarah Levitz, 324673623, sarah.levitz@mail.huji.ac.il  
Carmel Baris, 318455276, carmel.baris@mail.huji.ac.il  

## Setup
```{r libs}
# Clean the environment
rm(list = ls())

# Load required packages
library('data.table')
library('splines')
library('quantreg')
```

## Loading helper functions
```{r helpers}
# Set working directory
dir_name = "C:/Users/user/Documents/Carmel/Projects/HUJI/Archive_HUJI/data-analysis-genomics/data/"

# Load helper functions
helpers_file = file.path(dir_name, "help_funcs_v5.R")
source(helpers_file)
helpers = list(
    loadRData = loadRData,
    binBases = binBases,
    binReads = binReads
)
```

## Load data
```{r dat}
bases_file = file.path(dir_name, "chr1_line.rda")
chr1_bases = helpers$loadRData(bases_file)
reads_file_all = file.path(dir_name, "TCGA-13-0723-01A_lib2_all_chr1.forward")
chr1_reads = data.table::fread(reads_file_all)
colnames(chr1_reads) = c("Chrom", "Loc", "FragLen")
```

## Preprocess data
```{r preprocess}
nreads = nrow(chr1_reads)
myLocations = as.numeric(chr1_reads$Loc)
last_read = myLocations[nreads]
binsize = 20000
bases_20K = helpers$binBases(chr1_bases, last_read, binsize)
GC_20K = bases_20K[, 3] + bases_20K[, 4]
if(any(GC_20K>1)){GC_20K = GC_20K / binsize}

reads_20K = helpers$binReads(myLocations, binsize, last_read)
save(reads_20K, GC_20K, file = file.path(dir_name, "reads_gc_20K.rda"))
```

## Removing outliers
```{r outliers}
# Defining logical vectors for filtering out bins (observations)
zeros_GC = GC_20K == 0 #bins w/o GC content
small_GC = GC_20K <= 0.3 & GC_20K > 0 #low-GC content bins (<30%)
valid_GC = GC_20K  > 0.3 #bins w/ at least 30% GC content

# identify outliers of reads count per bin
zeros_reads = reads_20K == 0 #bins w/o any reads
zscore_line = scale(reads_20K)
xtreme_reads = abs(zscore_line) > 2
whiskers = boxplot.stats(reads_20K)$stats[c(1, 5)]
confounders = reads_20K < whiskers[1] | reads_20K > whiskers[2]

# create new variables without outliers
outliers = (zeros_GC | small_GC | zeros_reads | xtreme_reads | confounders)
reads_20K_clean = reads_20K[!outliers]
GC_20K_clean = GC_20K[!outliers]

few_reads = 0 < reads_20K & reads_20K < 350
outliers2 = (zeros_GC | small_GC | zeros_reads | xtreme_reads | few_reads | confounders)
reads_20K_clean2 = reads_20K[!outliers]
GC_20K_clean2 = GC_20K[!outliers]

# par(mfrow = c(2,1))
# boxplot(reads_20K_clean, horizontal = TRUE)
# boxplot(reads_20K_clean2, horizontal = TRUE)
# par(mfrow = c(1,1))
```

## Benchmark: fit bspline regression (pre-split)
```{r plot_benchmark}
plot(GC_20K, reads_20K, pch = 16, cex = 0.5, col = rgb(0, 0, 0, 0.7),
     xlab = "GC Content (cleaned)", ylab = "Read Counts (cleaned)",
     xlim = c(min(GC_20K_clean),max(GC_20K_clean)),
     ylim = c(min(reads_20K_clean),max(reads_20K_clean)),
     main = "B-spline Regression")

# Fit the regression models
knots_bs = c(0.415, 0.45, 0.54)
lknot = min(GC_20K)
rknot = max(GC_20K)
reg_bs = lm(subset = !outliers,
             formula = reads_20K ~ bs(GC_20K, degree = 3, 
                                      knots = knots_bs, 
                                      Boundary.knots = c(lknot, rknot)))

# Create new data for prediction
new_data <- data.frame(GC_20K = seq(min(GC_20K_clean), max(GC_20K_clean), length.out = 1000))
new_data$predicted <- predict(reg_bs, newdata = new_data)

# Plot the B-spline regression line
lines(new_data$GC_20K, new_data$predicted, col = "blue", lwd = 2)

# Add vertical lines to indicate breakpoints
abline(v = knots_bs, lty = 2, col = "darkgray", lwd = 1.5)

# Calculate residuals
residuals <- resid(reg_bs)

# Create GC groups of percentages (e.g., 2% intervals)
breaks <- seq(0.3, 0.7, by = 0.02)
GC_groups <- cut(GC_20K_clean, breaks = breaks, include.lowest = TRUE, right = FALSE)

# Count the number of data points in each group
group_counts <- table(GC_groups)

# Create a color palette of blue hues
blue_palette <- colorRampPalette(c("lightblue", "darkblue"))(length(unique(group_counts)))

# Assign colors based on counts
group_colors <- blue_palette[as.numeric(cut(group_counts, breaks = length(blue_palette)))]

# Set up the plot area
par(mar = c(5, 4, 4, 2) + 0.1)

# Create the boxplot
boxplot(residuals ~ GC_groups, 
        main = "Residuals vs. GC Groups",
        xlab = "GC Content (Cleaned)",
        ylab = "Residuals",
        outline = TRUE,
        whisklty = 1,
        staplelty = 0,
        boxwex = 0.8,
        border = "black",
        col = group_colors,
        xaxt = "n")  # Remove default x-axis

# Create simplified x-axis labels
major_breaks <- seq(30, 70, by = 5)
axis(1, at = seq(1, length(levels(GC_groups)), length.out = length(major_breaks)), 
     labels = paste0(major_breaks, "%"))

# Add minor ticks for all groups
axis(1, at = 1:length(levels(GC_groups)), labels = FALSE, tcl = -0.2)

# Add a reference line at y = 0
abline(h = 0, col = "red", lty = 2)

# Add a legend for color interpretation
legend("bottomright", legend = c("Fewer", "More"), 
       fill = c(blue_palette[1], blue_palette[length(blue_palette)]), 
       title = "Number of Observations", cex = 0.8,
       bty = "n")
```

## Residuals vs. Predicted Reads Count Per Bin
```{r plot_res_preds}
# Assuming you have calculated residuals and have reads_20K_clean

# Create groups for reads_20K_clean
reads_breaks <- seq(min(reads_20K_clean), max(reads_20K_clean), length.out = 21)
reads_groups <- cut(reads_20K_clean, breaks = reads_breaks, include.lowest = TRUE, right = FALSE)

# Count the number of data points in each group
group_counts <- table(reads_groups)

# Create a color palette of blue hues
blue_palette <- colorRampPalette(c("lightblue", "darkblue"))(length(unique(group_counts)))

# Assign colors based on counts
group_colors <- blue_palette[as.numeric(cut(group_counts, breaks = length(blue_palette)))]

# Set up the plot area
par(mar = c(5, 4, 4, 2) + 0.1)

# Create the boxplot
boxplot(residuals ~ reads_groups, 
        main = "Residuals vs. Predicted Reads Count Per Bin",
        xlab = "Predicted Reads Count",
        ylab = "Residuals",
        outline = TRUE,
        whisklty = 1,
        staplelty = 0,
        boxwex = 0.8,
        border = "

black",
        col = group_colors,
        xaxt = "n")  # Remove default x-axis

# Create simplified x-axis labels
major_breaks <- seq(min(reads_20K_clean), max(reads_20K_clean), length.out = 11)
axis(1, at = seq(1, length(levels(reads_groups)), length.out = length(major_breaks)), 
     labels = round(major_breaks, 1))

# Add minor ticks for all groups
axis(1, at = 1:length(levels(reads_groups)), labels = FALSE, tcl = -0.2)

# Add a reference line at y = 0
abline(h = 0, col = "red", lty = 2)

# Add a legend for color interpretation
legend("bottomright", legend = c("Fewer", "More"), 
       fill = c(blue_palette[1], blue_palette[length(blue_palette)]), 
       title = "Number of Observations", cex = 0.8,
       bty = "n")
```

## Summary
1. **Model Fitting**: We fitted a B-spline regression model with degree 3, using specified knots. The regression line shows the predicted relationship between GC content and read counts after removing outliers.
2. **Residuals Analysis**: Residuals were plotted against both GC groups and predicted read counts to examine model performance.
3. **Outliers Management**: By filtering bins with low or zero GC content and extreme read counts, we improved model fitting and residual analysis.
4. **Visualization**: Comprehensive visualizations were created to inspect the distribution and residuals of the fitted model, aiding in model diagnostics and understanding of data behavior.

In this analysis, we successfully applied a piecewise polynomial model to approximate the relationship between GC content and read counts, providing insights and highlighting areas for further improvement.

