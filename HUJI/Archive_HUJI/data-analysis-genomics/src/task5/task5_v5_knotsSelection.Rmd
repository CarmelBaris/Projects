---
title: "Lab Task 4: Approx. Regression w/ Piecewise Polynomial Model"
author: "Group 6"
date: Sys.Date()
output:
  html_document:
    code_folding: show
editor_options: 
  markdown: 
    wrap: sentence
---

Group members:

- Shawn Yakir , 315714980, shawnyakir@gmail.com
- Sarah Levitz, 324673623, sarah.levitz@mail.huji.ac.il
- Carmel Baris, 318455276, carmel.baris@mail.huji.ac.il 


## Setup

```{r setup}

# Clean the environment
rm(list = ls())

# Load required packages
library('data.table')
library('splines')

# Set working directory
# dir_name = "/Users/alevi/Downloads/"
dir_name = "C:/Users/user/Documents/Carmel/Projects/HUJI/Archive_HUJI/data-analysis-genomics/data/"

# Load helper functions
helpers_file = file.path(dir_name, "help_funcs_v5_1.R")
source(helpers_file)
helpers = list(
    loadRData = loadRData,
    fitMet = fitMetrics,
    binBases = binBases,
    binReads = binReads,
    chk_ratio = check_proportions,
    chk_ovrlp = check_overlaps,
    chk_size = check_data_size,
    fit_bspline = fit_bspline,
    plot_bspline = plot_bspline_results
    )

# Load data
bases_file = file.path(dir_name, "chr1_line.rda")
chr1_bases = helpers$loadRData(bases_file)
reads_file_all = file.path(dir_name, "TCGA-13-0723-01A_lib2_all_chr1.forward")
chr1_reads = data.table::fread(reads_file_all)
colnames(chr1_reads) = c("Chrom", "Loc", "FragLen")

# Preprocess data
nreads = nrow(chr1_reads)
myLocations = as.numeric(chr1_reads$Loc)
last_read = myLocations[nreads]
binsize = 20000
bases_20K = helpers$binBases(chr1_bases, last_read, binsize)
GC_20K = bases_20K[, 3] + bases_20K[, 4]
if(any(GC_20K>1)){GC_20K = GC_20K / binsize}

reads_20K = helpers$binReads(myLocations, binsize, last_read)
save(reads_20K, GC_20K, file = file.path(dir_name, "reads_gc_20K.rda"))
```




## Removing outliers

```{r outliers}

# Defining logical vectors for filtering out bins (observations)

# outliers of gc percent per bin
zeros_GC = GC_20K == 0 #bins w/o GC content
small_GC = GC_20K <= 0.3 & GC_20K > 0 #low-GC content bins (<30%)
valid_GC = GC_20K  > 0.3 #bins w/ at least 30% GC content

# identify outliers of reads count per bin
zeros_reads = reads_20K == 0 #bins w/o any reads
mean_reads = mean(reads_20K)
sd_reads = sd(reads_20K)
lwr = mean_reads - 2 * sd_reads
upr = mean_reads + 2 * sd_reads
normal_reads = (lwr <= reads_20K & reads_20K <= upr)
xtreme_reads = !(normal_reads|zeros_reads) #based on z-score threshold of 2

# create new variables without outliers
outliers = (zeros_GC | small_GC | zeros_reads | xtreme_reads)
reads_20K_clean = reads_20K[!outliers]
GC_20K_clean = GC_20K[!outliers]

```



## Sanity checks for removing outliers process

```{r qa_outliers}

gc_len_valid = length(GC_20K) == sum(zeros_GC)+sum(small_GC)+sum(valid_GC)
read_len_valid = length(reads_20K) == sum(normal_reads)+sum(xtreme_reads)

cat("GC & Reads started out same length?\n", length(reads_20K) == length(GC_20K))
cat("\nGC_clean & Reads_clean ended up same length?\n", length(reads_20K_clean) == length(GC_20K_clean))
cat("GC outliers removal ok?\n", gc_len_valid)
cat("Read outliers removal ok?\n", read_len_valid)

# Calculate sums and percentages
values <- c(sum(zeros_GC), sum(small_GC), sum(zeros_reads), sum(xtreme_reads), sum(outliers))
percentages <- (values / length(outliers)) * 100
percentages_formatted <- sprintf("%.2f%%", percentages)

# Create a data frame
table_data <- data.frame(
  Outliers_Condition = c("GC=0%", "0%<GC<30%", "0 Reads", "Xtreme Reads", "Total"),
  Num_Observed = values,
  Percentage = percentages_formatted <- sprintf("%.2f%%", percentages)
)

sorted_table_data <- table_data[order(table_data$Percentage), ]

print(sorted_table_data)

```




## Benchmark: fit bspline regression (all data)

```{r fit}

plot(GC_20K, reads_20K, pch = 16, cex = 0.5, col = rgb(0, 0, 0, 0.7),
     xlab = "GC Content (cleaned)", ylab = "Read Counts (cleaned)",
     xlim = c(min(GC_20K_clean),max(GC_20K_clean)),
     ylim = c(0,max(reads_20K_clean)),
     main = "Piecewise Polynomial Regression")



# Fit the regression models
left_knot = min(GC_20K)
right_knot = max(GC_20K)
reg_bs_3knots <- lm(reads_20K
                    ~ bs(GC_20K, knots = c(0.415, 0.45, 0.54), degree = 3,
                         Boundary.knots = c(left_knot, right_knot)),
                    subset = !outliers)

reg_bs_4knots <- lm(reads_20K
                    ~ bs(GC_20K, knots = c(0.37, 0.415, 0.45, 0.54), degree = 3, 
                         Boundary.knots = c(left_knot, right_knot)),
                    subset = !outliers)

# Get the summaries of the models
summary_reg_bs_3knots <- summary(reg_bs_3knots)
summary_reg_bs_4knots <- summary(reg_bs_4knots)

# Calculate MSE for both models
mse_3knots <- mean(summary_reg_bs_3knots$residuals^2)
mse_4knots <- mean(summary_reg_bs_4knots$residuals^2)

# Calculate MSPE
predicted_3knots <- predict(reg_bs_3knots, newdata = data.frame(GC_20K_clean))
predicted_4knots <- predict(reg_bs_4knots, newdata = data.frame(GC_20K_clean))

mspe_3knots <- mean((reads_20K_clean - predicted_3knots)^2)
mspe_4knots <- mean((reads_20K_clean - predicted_4knots)^2)

# Print the results
cat("MSE for 3 knots model: ", mse_3knots, "\n")
cat("MSE for 4 knots model: ", mse_4knots, "\n")
cat("MSPE for 3 knots model: ", mspe_3knots, "\n")
cat("MSPE for 4 knots model: ", mspe_4knots, "\n")

```


```{r}



knots_bs = c(0.37, 0.415, 0.45, 0.54)

# Fit the B-spline model using subset argument to exclude outliers
reg_bs = lm(reads_20K ~ bs(GC_20K, knots = knots_bs, degree = 3, Boundary.knots = c(min(GC_20K), max(GC_20K))), subset = !outliers)

# Create new data for prediction
new_data <- data.frame(GC_20K = seq(min(GC_20K_clean), max(GC_20K_clean), length.out = 1000))
new_data$predicted <- predict(reg_bs, newdata = new_data)

# Plot the B-spline regression line
lines(new_data$GC_20K, new_data$predicted, col = "blue", lwd = 2)

# Add vertical lines to indicate breakpoints
abline(v = knots_bs, lty = 2, col = "darkgray", lwd = 1.5)

# Add legend
legend("topleft", legend = "B-spline Regression", col = "blue", lwd = 2, cex = 0.7)






```


```{r residuals}
pred_bs = predict(reg_bs)
res_bs = reads_20K_clean - pred_bs

plot(GC_20K_clean, res_bs, pch = 16, cex = 0.5, col = rgb(0, 0, 0, 0.5),
     xlab = "GC Content (cleaned)", ylab = "Residuals",
     main = "Residuals of Segmented Model")
abline(h = 0, col = "darkgray", lwd = 1.5)



```






## QUESTION 1: 

## Splitting to test and train (three versions)
```{r split}
# Create indices for dividing the data
set.seed(100)  # For reproducibility

# Division 1: Data into 20 parts and randomly assigning 14 parts to train
n_parts = 20
indices = 1:n_parts
train_indices_div1 = sample(indices, 14)
test_indices_div1 = setdiff(indices, train_indices_div1)

# Create train and test sets for Division 1
train_div1 = reads_20K[train_indices_div1]
test_div1 = reads_20K[test_indices_div1]

# Division 2: Completely random division (70% train, 30% test)
n_samples = length(reads_20K)
train_indices_div2 = sample(1:n_samples, 0.7 * n_samples)
test_indices_div2 = setdiff(1:n_samples, train_indices_div2)

# Create train and test sets for Division 2
train_div2 = reads_20K[train_indices_div2]
test_div2 = reads_20K[test_indices_div2]

# Division 3: Regular division (first 70% train, last 30% test)
train_indices_div3 = 1:floor(0.7 * n_samples)
test_indices_div3 = (floor(0.7 * n_samples) + 1):n_samples

# Create train and test sets for Division 3
train_div3 = reads_20K[train_indices_div3]
test_div3 = reads_20K[test_indices_div3]

```


#### Sanity checks for splitting process

```{r qa_split}
#+++++++++++ Check Proportions
# Division 1
props_div1 = helpers$chk_ratio(train_div1, test_div1, 14/20)
cat("Div1 props\n", 
    "Test proportion:", props_div1$test_ratio, "\n",
    "Train proportion:", props_div1$train_ratio, "\n",
    "Expected proportion of train:", props_div1$expected_train_ratio,
     "\n\n"
    )

# Division 2
props_div2 = helpers$chk_ratio(train_div2, test_div2, 0.7)
cat("Div2 props\n", 
    "Test proportion:", props_div2$test_ratio, "\n",
    "Train proportion:", props_div2$train_ratio, "\n",
    "Expected proportion of train:", props_div2$expected_train_ratio,
     "\n\n"
    )

# Division 3
props_div3 = helpers$chk_ratio(train_div3, test_div3, 0.7)
cat("Div3 props\n", 
    "Test proportion:", props_div3$test_ratio, "\n",
    "Train proportion:", props_div3$train_ratio, "\n",
    "Expected proportion of train:", props_div3$expected_train_ratio,
     "\n\n"
    )

#+++++++++++ Check for Overlaps
cat("\n OVERLAP TEST \n\n")

# Division 1
overlaps_div1 = helpers$chk_ovrlp(train_indices_div1, test_indices_div1)
paste0("Has Div1 passed overlap test? ", overlaps_div1)

# Division 2
overlaps_div2 = helpers$chk_ovrlp(train_indices_div2, test_indices_div2)
paste0("Has Div2 passed overlap test? ", overlaps_div2)

# Division 3
overlaps_div3 = helpers$chk_ovrlp(train_indices_div3, test_indices_div3)
paste0("Has Div3 passed overlap test? ", overlaps_div3)

#+++++++++++ Check Data Integrity

cat("\n SIZE TEST\n\n")

# debugonce(helpers$chk_size) # @CB

# Division 1
size_div1 = helpers$chk_size(train_div1, test_div1, reads_20K)
paste0("Has Div1 passed size test? ", size_div1)

# Division 2
size_div2 = helpers$chk_size(train_div2, test_div2, reads_20K)
paste0("Has Div2 passed size test? ", size_div2)

# Division 3
size_div3 = helpers$chk_size(train_div3, test_div3, reads_20K)
paste0("Has Div3 passed size test? ", size_div3)

```







## Q1.b+c+d


```{r fit_compare}
# Define knots by quantiles (0.25, 0.50, 0.75 of the data range)
# knots_bs = c(-0.67, 0, 0.67)  # Standardized positions for knots

# Fit Spline Regression using BSplines
# Warning in bs(x_train_scaled, degree = 3L, knots = c(-0.67, 0, 0.67), Boundary.knots = c(-1.73175054161184,  :
#   some 'x' values beyond boundary knots may cause ill-conditioned bases
 
bspline_div1 = helpers$fit_bspline(train_div1, test_div1, knots_bs)
bspline_div2 = helpers$fit_bspline(train_div2, test_div2, knots_bs)
bspline_div3 = helpers$fit_bspline(train_div3, test_div3, knots_bs)

# Division 1
print("Division 1: Train Metrics")
print(bspline_div1$metrics_train)
print("Division 1: Test Metrics")
print(bspline_div1$metrics_test)

# Division 2
print("Division 2: Train Metrics")
print(bspline_div2$metrics_train)
print("Division 2: Test Metrics")
print(bspline_div2$metrics_test)

# Division 3
print("Division 3: Train Metrics")
print(bspline_div3$metrics_train)
print("Division 3: Test Metrics")
print(bspline_div3$metrics_test)

# Plotting the results for visual inspection
helpers$plot_bspline(train_div1, test_div1, bspline_div1$pred_train, bspline_div1$pred_test, "Division 1: BSpline Regression")

helpers$plot_bspline(train_div2, test_div2, bspline_div2$pred_train, bspline_div2$pred_test, "Division 2: BSpline Regression")

helpers$plot_bspline(train_div3, test_div3, bspline_div3$pred_train, bspline_div3$pred_test, "Division 3: BSpline Regression")


```





