---
title: "Lab Task 8"
author: "Group 6"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output:
  html_document:
    code_folding: show
editor_options: 
  markdown: 
    wrap: sentence
---

Group members:

- Shawn Yakir , 315714980,  shawn.yakir@mail.huji.ac.il
- Sarah Levitz, 324673623, sarah.levitz@mail.huji.ac.il
- Carmel Baris, 318455276, carmel.baris@mail.huji.ac.il 

### Clean the environment
```{r clean}
rm(list = ls())
```

### Libraries used

```{r libraries}
library('splines')
library('scales')
library('caret')
```


### Paths
```{r paths}
path = "C:/Users/user/Documents/Carmel/Projects/HUJI/Archive_HUJI/data-analysis-genomics/data"
# path = "/Users/alevi/Downloads/"
 # path = "\\Users\\shawn\\Desktop\\"
```


### Functions

Fitting bspline regression:

```{r fit}
f = function(X, Y, deg=3, knots=c(0.415, 0.45, 0.54), subs) {
  lm(Y ~ bs(X, degree = deg, knots = knots, Boundary.knots = c(min(X), max(X))),
     subset = subs)
}

```


### Load data
```{r dat}
load(sprintf("%s/reads_100_A2.rda",path))
load(sprintf("%s/reads_100_B2.rda",path))
load(sprintf("%s/GC_100.rda",path))
```

### Binning
```{r binning}
binsize = 25

chr2t_mat = matrix(reads_100_A2, nr = binsize)
chr2n_mat = matrix(reads_100_B2, nr = binsize)
GC_100=GC_100[1: (length(reads_100_A2)) ]
gc_mat = matrix(GC_100,nr=binsize)

reads2.5K_t2 = colSums(chr2t_mat)
reads2.5K_n2 = colSums(chr2n_mat)
GC2.5K = colMeans(gc_mat)

length(reads2.5K_n2) == length(reads2.5K_t2)

## ------------------------------------------------
rm("chr2n_mat","chr2t_mat","gc_mat","reads_100_A2","reads_100_B2","GC_100") # remove from memory
```


### Outliers
```{r outliers_new}

find_out_boxplot = function(dat) {
  out = boxplot.stats(dat)$out
  out_ind = dat %in% out
  return(as.integer(out_ind))
}

out_t2 = find_out_boxplot(reads2.5K_t2)
out_n2 = find_out_boxplot(reads2.5K_n2)
out_reads_xtra = (reads2.5K_t2<5) | (reads2.5K_n2<5)

outliers = (out_t2 | out_n2 | out_reads_xtra)
r_health_cln = reads2.5K_n2[!outliers]
r_tumor_cln = reads2.5K_t2[!outliers]
GC_cln = GC2.5K[!outliers]

cat("removed", round((1-(length(GC_cln)/length(GC2.5K)))*100,2),"% outliers")

## ------------------------------------------------
rm("path", "find_out_boxplot","out_n2","out_reads_xtra","out_t2") # remove from memory
```


### Plotting Setup
```{r params}
set.seed(50)
samp1 = sample(length(r_health_cln), 10000)
col_healthy = "cornflowerblue"
color_tumor = "navy"
# col_healthy = rgb(0.3, 0.3, 0.3, 0.4)
# color_tumor = rgb(0.8, 0.8, 0.8, 0.6)
```

### Scaling Samples

```{r plot_scaling}
set.seed(50)
samp1 = sample(length(r_health_cln), 10000)

par(mfrow = c(2, 2), mar = c(0, 5, 3, 1))
# par(mfrow = c(2, 2))

plot(GC_cln[samp1], r_health_cln[samp1], 
     cex = 0.4, pch = 20, col = col_healthy,
     ylim = c(0, 450), xlim = c(0.2, 0.75), 
     ylab = "Pre-Scaling", xlab = "", xaxt = "n",
     main = "Healthy")

plot(GC_cln[samp1], r_tumor_cln[samp1], 
     cex = 0.4, pch = 20, col = color_tumor,
     ylim = c(0, 450), xlim = c(0.2, 0.75),
     ylab = "", xlab = "", xaxt = "n",
     main = "Tumor")

### Scaled down the tumor sample for comparison
### Note: Don't scale up the smaller (healthy) sample bc you'll see gaps
plot(GC_cln[samp1], scales::rescale(r_health_cln, to = c(0, 200))[samp1], 
     cex = 0.4, pch = 20, col = col_healthy,
     ylim = c(0, 250), xlim = c(0.2, 0.75), 
     ylab = "Scaled", xlab = "", xaxt = "n",  
     main = "")
plot(GC_cln[samp1], scales::rescale(r_tumor_cln, to = c(0, 200))[samp1], 
     cex = 0.4, pch = 20, col = color_tumor,
     ylim = c(0, 250), xlim = c(0.2, 0.75), 
     ylab = "", xlab = "", xaxt = "n")
plot(1)
```

### Correlation Between Samples (Scaled)

```{r cor_tumor_health_scaled}
par(mfcol = c(1,2), mar = c(10, 5, 2.5, 1), oma = c(4,2.5,1,2.5))

# Plot the data points first
plot(scales::rescale(r_health_cln, to = c(0, 200)), 
     scales::rescale(r_tumor_cln, to = c(0, 200)),  
  col = c(color_tumor,"white"), pch = c(20,0), cex = c(0.5,0), 
     ylab = "", xlab = "", main = "", ylim = c(0,200))

# Add diagonal line
abline(0, 1)
text(x = 100, y = 115, label = "1:1 ratio", srt = 35, col = "white", cex = 0.8) 

# add labels for axes
mtext("Healthy", side = 1, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)
mtext("Tumor", side = 2, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)

# Plot the data points first
plot(scales::rescale(r_health_cln, to = c(0, 200)), 
     scales::rescale(r_tumor_cln, to = c(0, 200)),  
  col = c("white",col_healthy), pch = c(0,20), cex = c(0,0.5), 
     ylab = "", xlab = "", main = "", ylim = c(0,200))

# Add diagonal line
abline(0, 1)
text(x = 100, y = 115, label = "1:1 ratio", srt = 35, col = "white", cex = 0.8) 

# add labels for axes
mtext("Healthy", side = 1, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)
mtext("Tumor", side = 2, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)

# Add legend
# legend("bottomright", legend = c("Healthy Sample", "Tumor Sample"), col = c("skyblue", "indianred"), pch=20, bty = "n", cex = 0.7)

par(mar=c(0,0,0,0))

## write text on outer margins
mtext("Correlation Between Samples", outer=TRUE, side=3, line=-0.5, font=2)
legend("bottomleft", inset=c(-0.5,-1), xpd=NA, horiz = TRUE,
       title="Sample Obs.", legend=c("Healthy","Tumor"), 
       col=c(col_healthy, color_tumor), pch=19, bty="n")

#        horiz = TRUE,
# Back to the default graphical parameters
on.exit(par(par))
plot(1)
```



### Correlation Between Samples (Pre-Scaled)

```{r cor_tumor_health_original}
par(mfcol = c(1,2), mar = c(10, 5, 2.5, 1), oma = c(3,4,2,4))

# Plot the data points first
plot(
  r_health_cln, r_tumor_cln, col = c(col_healthy,"white"), pch = c(20,0), cex = c(0.5,0), 
     ylab = "", xlab = "", main = "", ylim = c(0,450))

# Add diagonal line
abline(0, 2)
text(x = 80, y = 250, label = "1:2 ratio", srt = 25, col = "gray3", cex = 0.8) 

# add labels for axes
mtext("Healthy", side = 1, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)
mtext("Tumor", side = 2, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)

# Plot the data points first
plot(r_health_cln, r_tumor_cln,  col = c("white",color_tumor), pch = c(0,20), cex = c(0,0.5), 
     ylab = "", xlab = "", main = "", ylim = c(0,450))

# Add diagonal line
abline(0, 2)
text(x = 80, y = 250, label = "1:2 ratio", srt = 30, col = "white", cex = 0.8) 

# add labels for axes
mtext("Healthy", side = 1, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)
mtext("Tumor", side = 2, cex = 1, col = rgb(0,0,0,0.8), line = 2.5)

# Add legend
# legend("bottomright", legend = c("Healthy Sample", "Tumor Sample"), col = c("skyblue", "indianred"), pch=20, bty = "n", cex = 0.7)

legend(x = "bottomleft",
       inset = c(-0.5, -1.5), # You can fine-tune this coordinate to fit
       legend = c("Healthy Sample", "Tumor Sample"), 
       pch = 19,
       cex = 0.8,
       col = c(col_healthy, color_tumor),
       xpd = TRUE, # Needed to put the legend outside the plot
       horiz = TRUE,
       bty = "n")

## write text on outer margins
mtext("Correlation Between Samples",outer = TRUE, side = 3, line = 0.3, font = 2)
# mtext("Est. Number of Copies (a hat)", outer = TRUE, side = 3, line = 1, cex = 0.8)
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", outer = FALSE, side = 1, cex = 0.8, line = -2)

# Back to the default graphical parameters
on.exit(par(opar))
plot(1)
```


### Healthy Fit vs. Tumor Fit
```{r fit_models}
l_2n = length(r_health_cln)
l_2t = length(r_tumor_cln)

myknots = c(0.415, 0.45, 0.54)
pred_range = seq(0.2,0.75,0.01)

GC=GC_cln[1:l_2n]
r_health_cln = r_health_cln
r_tumor_cln = r_tumor_cln

subs_n = (r_health_cln>50)&(r_health_cln<350)
subs_t = (r_tumor_cln>50)&(r_tumor_cln<350)

# mod_2n = f(GC, r_health_cln, subs = subs_n)
# mod_2t = f(GC, r_tumor_cln, subs = subs_n)
mod_2n = lm(r_health_cln~bs(GC, degree = 3),subset = subs_n)
mod_2t = lm(r_tumor_cln~bs(GC, degree = 3),subset = subs_t)

resp2n = predict(mod_2n,list(GC=pred_range))
preds2n = predict(mod_2n,list(GC=GC_cln))

resp2t = predict(mod_2t,list(GC=pred_range))
preds2t = predict(mod_2t,list(GC=GC_cln))

```

```{r plot_cleaned}
par(mfcol = c(1,2),mar = c(3,5,3,3))

plot(GC_cln[samp1],r_health_cln[samp1],
     cex = 0.5, pch=20, col = col_healthy,
     ylim = c(0,350),xlim = c(0.2,.75), 
     ylab = "Cleaned Reads (bins of 2,500)", main = "Healthy 2")
lines(pred_range, resp2n,col = 4,lw=3)

plot(GC_cln[samp1],r_tumor_cln[samp1],
     cex = 0.5, pch=20, col = color_tumor,
     ylim = c(0,350),xlim = c(.2,.75), 
     ylab = "", main = "Tumor 2")
lines(pred_range, resp2t,col = 2,lw=3)
lines(pred_range, resp2n,col = 4,lw=3)

plot(1)
```


```{r fits_preds}
# Fit B-spline Regression Models
mod_healthy = lm(r_health_cln ~ bs(GC_cln, degree = 3))
mod_tumor = lm(r_tumor_cln ~ bs(GC_cln, degree = 3))


preds_healthy = predict(mod_healthy, newdata = data.frame(GC_cln = pred_range))
preds_tumor = predict(mod_tumor, newdata = data.frame(GC_cln = pred_range))

```

Correcting functions:

```{r correcting_funcs}

### My one sample corrections ...

### Median correction
fix_med = function(samp) {
  return(samp/median(samp,na.rm=TRUE))
}

### One sample correction
fix_gc_e = function(samp, preds, eps=0) {
  return((samp+eps)/(preds+eps))
}

### My two sample correction ...
fix_2samp_e = function(tumor, healthy, eps=0) {
  return((tumor+eps)/(healthy+eps))
}

```



### Applying fixes
```{r fix_apply}
# take maximum with 0
preds1n = pmax(predict(mod_2n,list(GC=GC_cln)),0)
preds1t = pmax(predict(mod_2t,list(GC=GC_cln)),0)


# One Sample with espilon, Healthy
eps = 0.3
fixed_2n_gc_med_eps = fix_med(fix_gc_e(r_health_cln, preds1n[1:l_2n], eps))
unfixed_2n_gc_med_eps = fix_med(fix_gc_e(r_health_cln, rep(1,l_2n), eps))

# One Sample with espilon, Tumor
eps = 0.3
fixed_2t_gc_med_eps = fix_med(fix_gc_e(r_tumor_cln, preds1t[1:l_2t], eps))
unfixed_2t_gc_med_eps = fix_med(fix_gc_e(r_tumor_cln, rep(1,l_2t), eps))
```

### Plotting fixes

```{r plot_gcfix_be4_after}
par(mfcol = c(2,2),mar = c(3,5,2,2))
loc2bin = function(v, bin_size){
  return((v*1000000)/bin_size)}

bins = loc2bin(c(25,35,75,80),2500)
stiched_range = c(bins[1]:bins[2], bins[3]:bins[4])
# stiched_range = c(10000:14000,15000:16000)
plot(unfixed_2t_gc_med_eps[stiched_range], 
     main = "GC Fix for Tumor Sample",
     ylab = "Before", xaxt = "n",
     ylim = c(0,2), xlim = c(0,6000),
     cex = 1, pch=20, col = color_tumor
     )
abline(h=1,col=4, lwd = 2)
abline(h=c(0.75,1.25),col=4, lwd = 1.5, lt = 2)
abline(v=4000,col=6, lwd = 1.2)

plot(fixed_2t_gc_med_eps[stiched_range], 
     ylab = "After", xaxt = "n", col = color_tumor,
     ylim = c(0,2),cex = 1,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 2)
abline(h=c(1, 0.75,1.25),col=4, lwd = c(2, 1.5, 1.5), lt = c(1,2,2))
abline(v=4000,col=6, lwd = 1.2)

# plot(1)
## ------------------------------------------------

plot(unfixed_2n_gc_med_eps[stiched_range], 
     main = "GC Fix for Healthy Sample",
     cex = 1, pch=20, col = col_healthy,
     ylab = "", xaxt = "n", ylim = c(0,2), xlim = c(0,6000))
abline(h=1,col=4, lwd = 2)
abline(h=c(0.7,1.3),col=4, lwd = 1.5, lt = 2)
abline(v=4000,col=6, lwd = 1.2)
plot(fixed_2n_gc_med_eps[stiched_range], 
     ylab = "", xaxt = "n", ylim = c(0,2), xlim = c(0,6000),
     cex = 1, pch=20, col = col_healthy)
abline(h=c(1, 0.75,1.25),col=4, lwd = c(2, 1.5, 1.5), lt = c(1,2,2))
abline(v=4000,col=6, lwd = 1.2)
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)                        
                                    ", 
      side = 1, cex = 0.9, line = 2.5, adj = 1)


plot(1)

## ------------------------------------------------
```


```{r plot_no_fix}
par(mfcol = c(2,1),mar = c(2,5,2,2))
# Plot for Healthy
plot(r_health_cln[stiched_range], 
     ylab = "Healthy",xaxt = "n",
     main = "Before Any Fix (Full Width)",
     ylim = c(0,400), cex = 0.6, pch=20, col = col_healthy)
# abline(h=1, col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
# Plot for Tumor
plot(r_tumor_cln[stiched_range], 
     ylab = "Tumor", xaxt = "n",
     ylim = c(0,400), cex = 0.6, pch=20, col = color_tumor)
# abline(h=1, col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", side = 1, cex = 0.8)

plot(1)

```

```{r plot_medfix}
par(mfcol = c(2,1),mar = c(2,5,2,2))
# Plot for Healthy
plot(unfixed_2n_gc_med_eps[stiched_range], 
     ylab = "Healthy",xaxt = "n",
     main = "After Median Fix (Full Width)",
     ylim = c(0,2), cex = 0.6, pch=20, col = col_healthy)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
# Plot for Tumor
plot(unfixed_2t_gc_med_eps[stiched_range], 
     ylab = "Tumor", xaxt = "n",
     ylim = c(0,2), cex = 0.6, pch=20, col = color_tumor)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", side = 1, cex = 0.8)

plot(1)

```

```{r plot_gcfix}
par(mfcol = c(2,1),mar = c(2,5,2,2))
# Plot for Healthy
plot(fixed_2n_gc_med_eps[stiched_range], 
     ylab = "Healthy",xaxt = "n",
     main = "After 'One Sample' GC Fix (Full Width)",
     ylim = c(0,2), cex = 0.6, pch=20, col = col_healthy)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
# Plot for Tumor
plot(fixed_2t_gc_med_eps[stiched_range], 
     ylab = "Tumor", xaxt = "n",
     ylim = c(0,2), cex = 0.6, pch=20, col = color_tumor)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", side = 1, cex = 0.8)

plot(1)

```



### My two sample corrections ...
```{r 2sampfix}
fix_2samp_e = function(tumor, healthy, eps=0) {
  return((tumor+eps)/(healthy+eps))
}

```



```{r correcting}
# after GC fix (no espilon)
gc_fixed_healthy = fix_med(fix_gc_e(r_health_cln, preds1n[1:l_2n]))
gc_fixed_tumor = fix_med(fix_gc_e(r_tumor_cln, preds1t[1:l_2t]))

# before GC fix (no espilon)
gc_unfixed_healthy = fix_med(fix_gc_e(r_health_cln, rep(1,l_2n)))
gc_unfixed_tumor = fix_med(fix_gc_e(r_tumor_cln, rep(1,l_2t)))

two_samp_med = fix_med(fix_2samp_e(gc_unfixed_tumor,gc_unfixed_healthy))
two_samp_med_eps0.3_gc = fix_med(fix_2samp_e(gc_fixed_tumor, gc_fixed_healthy, 0.3))
two_samp_med_eps0.3 = fix_med(fix_2samp_e(gc_unfixed_tumor,gc_unfixed_healthy, 0.3))
two_samp_med_epsone = fix_med(fix_2samp_e(gc_unfixed_tumor,gc_unfixed_healthy, 1.0))
two_samp_med_epsten = fix_med(fix_2samp_e(gc_unfixed_tumor,gc_unfixed_healthy,10.0))


```



```{r plot_t_1samp2samp}
par(mfcol = c(4,1),mar = c(1,5,4,3))


plot(unfixed_2t_gc_med_eps[stiched_range], 
     ylab = "Before", xaxt = "n",
     ylim = c(0,2), xlim = c(0,6000),
     cex = 1, pch=20, col = color_tumor
     )
abline(h=c(1, 0.5, 1.5),col=4, lwd = c(1.5, 1.5, 1.5), lt = c(1,2,2))
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
mtext("Incl. Median Fix (eps = 0.3)", line = 3, side = 3, cex = 0.8, col = rgb(0,0,0,0.8))
title("Applying Fixes to Tumor Sample", line = 5)

## one sample (median + GC correction)
plot(fixed_2t_gc_med_eps[stiched_range], 
     main = "Tumor Sample After Med+GC Fixes",
     ylab = "One Sample", xlab = "", xaxt = "n", ylim = c(0,2), xlim = c(0,6000),
     cex = 0.7, pch=20, col = color_tumor)
abline(h=c(1, 0.5, 1.5),col=4, lwd = c(1.5, 1.5, 1.5), lt = c(1,2,2))
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
mtext("Incl. Median & GC Fixes (eps = 0.3)", side = 3, cex = 0.8, col = rgb(0,0,0,0.8))

plot(two_samp_med_eps0.3[stiched_range], 
     main = "Two-Sample",
     ylab = "Two Sample", xlab = "", xaxt = "n", ylim = c(0,2), xlim = c(0,6000),
     cex = 0.7, pch=20, col = color_tumor)
abline(h=c(1, 0.5, 1.5),col=4, lwd = c(1.5, 1.5, 1.5), lt = c(1,2,2))
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", side = 1, cex = 0.8, line = 3)

plot(two_samp_med_eps0.3_gc[stiched_range], 
     main = "Two-Sample",
     ylab = "Two Sample", xlab = "", xaxt = "n", ylim = c(0,2), xlim = c(0,6000),
     cex = 0.7, pch=20, col = color_tumor)
abline(h=c(1, 0.5, 1.5),col=4, lwd = c(1.5, 1.5, 1.5), lt = c(1,2,2))
abline(v=c(750,900,4000),col=c("orange","orange",6), lwd = c(1.7, 1.7, 1.2))
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", side = 1, cex = 0.8, line = 3)

plot(1)

```


### Effects of the epsilon

```{r plot_epsilons}
## ----------------------

par(mfcol = c(4,1), mar = c(2,5,1,1))
plot(two_samp_med[stiched_range],
     main = "Comparing Epsilons in Two-Sample w/o GC",
     ylab = "epsilon = 0", xaxt = "n",
     ylim = c(0,2),cex = 0.2,pch=20, col = col_healthy)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_eps0.3[stiched_range],
     ylab = "epsilon = 0.3", xaxt = "n",
     ylim = c(0,2),cex = 0.2,pch=20, col = col_healthy)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_epsone[stiched_range],
     ylab = "epsilon = 1", xaxt = "n",
     ylim = c(0,2),cex = 0.2,pch=20, col = col_healthy)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_epsten[stiched_range],
     ylab = "epsilon = 10", xaxt = "n",
     ylim = c(0,2),cex = 0.2,pch=20, col = col_healthy)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", side = 1, cex = 0.8, line = 3)

plot(1)
```


```{r plot_gc_2samp}
## ----------------------
par(mfcol = c(2,1), mar = c(2,5,1,1))

plot(two_samp_med_eps0.3[stiched_range],
     main = "Combining GC & Two-Sample (Epsilon = 0.3)",
     ylab = "Before GC fix", xaxt = "n", xlab = "",
     ylim = c(0,2),cex = 0.5,pch=20, col = rgb(0.3,0.3,0.3,0.7))
abline(h=1,col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_eps0.3_gc[stiched_range], 
     ylab = "After GC fix", xaxt = "n", xlab = "",
     ylim = c(0,2),cex = 0.5, pch=20, col = rgb(0.3,0.3,0.3,0.7))
abline(h=1,col=4, lwd = 1.5)
abline(v=c(750,900,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)
mtext("Selected Locations in Chrom1 (25M-35M, 75M-80M)", side = 1, cex = 0.8)

plot(1)

```










```{r knot_kfold}
# Load necessary libraries
library(splines)  # For bs() function
library(ggplot2)  # For ggplot()
library(caret)    # For createFolds()

# Function to fit a B-spline model and compute MSE
fit_bspline = function(x, y, train_index, test_index, num_knots) {
  train_data = data.frame(x = x[train_index], y = y[train_index])
  test_data = data.frame(x = x[test_index], y = y[test_index])
  
  # Set the knots evenly within the range of x
  knots = quantile(train_data$x, probs = seq(0, 1, length.out = num_knots + 2)[-c(1, num_knots + 2)])
  
  model = lm(y ~ splines::bs(x, knots = knots), data = train_data)
  predictions = predict(model, newdata = test_data)
  mse = mean((test_data$y - predictions)^2)
  return(mse)
}

# Function to perform k-fold cross-validation
k_fold_cv = function(x, y, k, num_knots) {
  set.seed(42)
  folds = caret::createFolds(y, k = k, list = TRUE, returnTrain = TRUE)
  mse_values = sapply(folds, function(train_index) {
    test_index = setdiff(seq_along(y), train_index)
    fit_bspline(x, y, train_index, test_index, num_knots)
  })
  mean(mse_values)
}

# Function to select the optimal number of knots
select_optimal_knots_cv = function(x, y, min_knots, max_knots, k) {
  results = data.frame(knots = integer(), mse = numeric())
  
  for (num_knots in min_knots:max_knots) {
    mse = k_fold_cv(x, y, k, num_knots)
    results = rbind(results, data.frame(knots = num_knots, mse = mse))
  }
  
  optimal_knots = results$knots[which.min(results$mse)]
  optimal_mse = min(results$mse)
  
  return(list(optimal_knots = optimal_knots, optimal_mse = optimal_mse, results = results))
}

# Select optimal number of knots using 5-fold cross-validation for tumor sample
result_tumor = select_optimal_knots_cv(GC, r_tumor_cln, min_knots = 3, max_knots = 10, k = 5)

# Print optimal number of knots and corresponding MSE for tumor sample
print(paste("Optimal number of knots for tumor sample:", result_tumor$optimal_knots))
print(paste("Optimal MSE for tumor sample:", result_tumor$optimal_mse))

# Select optimal number of knots using 5-fold cross-validation for healthy sample
result_healthy = select_optimal_knots_cv(GC, r_health_cln, min_knots = 3, max_knots = 10, k = 5)

# Print optimal number of knots and corresponding MSE for healthy sample
print(paste("Optimal number of knots for healthy sample:", result_healthy$optimal_knots))
print(paste("Optimal MSE for healthy sample:", result_healthy$optimal_mse))

# Plot MSE vs number of knots for both samples
results_combined = rbind(
  cbind(result_tumor$results, Sample = "Tumor"),
  cbind(result_healthy$results, Sample = "Healthy")
)

ggplot2::ggplot(results_combined, aes(x = knots, y = mse, color = Sample)) +
  geom_line() +
  geom_point() +
  labs(title = "MSE vs Number of Knots (5-fold CV)", x = "Number of Knots", y = "MSE") +
  theme_minimal() +
  scale_color_manual(values = c("Tumor" = "red", "Healthy" = "blue"))

# Fit final model with optimal knots and plot predictions for both samples
optimal_knots_tumor = result_tumor$optimal_knots
knots_tumor = quantile(GC, probs = seq(0, 1, length.out = optimal_knots_tumor + 2)[-c(1, optimal_knots_tumor + 2)])
final_model_tumor = lm(r_tumor_cln ~ splines::bs(GC, knots = knots_tumor))
predictions_tumor = predict(final_model_tumor)

optimal_knots_healthy = result_healthy$optimal_knots
knots_healthy = quantile(GC, probs = seq(0, 1, length.out = optimal_knots_healthy + 2)[-c(1, optimal_knots_healthy + 2)])
final_model_healthy = lm(r_health_cln ~ splines::bs(GC, knots = knots_healthy))
predictions_healthy = predict(final_model_healthy)

# Plot predictions for tumor sample
ggplot2::ggplot(data.frame(x = GC, y = r_tumor_cln, predictions = predictions_tumor), aes(x = x, y = y)) +
  geom_point() +
  geom_line(aes(y = predictions), color = "red") +
  labs(title = paste("Final Model with", optimal_knots_tumor, "Knots (Tumor)"), x = "GC Content", y = "r_tumor_cln") +
  theme_minimal()

# Plot predictions for healthy sample
ggplot2::ggplot(data.frame(x = GC, y = r_health_cln, predictions = predictions_healthy), aes(x = x, y = y)) +
  geom_point() +
  geom_line(aes(y = predictions), color = "blue") +
  labs(title = paste("Final Model with", optimal_knots_healthy, "Knots (Healthy)"), x = "GC Content", y = "r_health_cln") +
  theme_minimal()

```

