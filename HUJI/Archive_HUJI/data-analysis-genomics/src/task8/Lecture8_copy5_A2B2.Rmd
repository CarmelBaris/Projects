---
title: "Lab Task 7"
author: "Group 6"
date: Sys.Date()
output:
  html_document:
    code_folding: show
editor_options: 
  markdown: 
    wrap: sentence
---

Group members:

- Shawn Yakir , 315714980,  shawn.yakir@mail.huji.ac.il
- Sarah Levitz, 324673623, sarah.levitz@mail.huji.ac.il
- Carmel Baris, 318455276, carmel.baris@mail.huji.ac.il 

### Clean the environment
```{r clean}
rm(list = ls())
```

### Libraries used

```{r libraries}
library('splines')
library('scales')
```


### Paths
```{r paths}
path = "~/Carmel/RProjects/Lab_Benjamini/data"
# path = "/Users/alevi/Downloads/"
# path = "\\Users\\shawn\\Desktop\\"
```


### Load data
```{r dat}
load(sprintf("%s/reads_100_A2.rda",path))
load(sprintf("%s/reads_100_B2.rda",path))
load(sprintf("%s/GC_100.rda",path))
GC_100=GC_100[1: (length(reads_100_A2)) ]
```

### Binning
```{r binning}
binsize = 25
chr2t_mat = matrix(reads_100_A2, nr = binsize)
reads2.5K_t2 = colSums(chr2t_mat)

chr2n_mat = matrix(reads_100_B2, nr = binsize)
reads2.5K_n2 = colSums(chr2n_mat)

gc_mat = matrix(GC_100, nr=binsize)
GC2.5K = colMeans(gc_mat)

```
### Outliers
```{r outliers}
# outliers of gc percent per bin
zeros_GC = GC2.5K == 0 #bins w/o GC content
# small_GC = GC2.5K <= 0.3 & GC2.5K > 0 #low-GC content bins (<30%)
# valid_GC = !(zeros_GC | small_GC) #bins w/ at least 30% GC content

# identify outliers of reads count per bin
z_scores_n2 = (reads2.5K_n2 - mean(reads2.5K_n2)) / sd(reads2.5K_n2)
z_scores_t2 = (reads2.5K_t2 - mean(reads2.5K_t2)) / sd(reads2.5K_t2)
xtreme_reads_n2 = abs(z_scores_n2) > 2
xtreme_reads_t2 = abs(z_scores_t2) > 2

# create new variables without outliers
outliers = (zeros_GC | xtreme_reads_t2 | xtreme_reads_n2)
outliers = (outliers | (reads2.5K_t2<50) | (reads2.5K_n2<50))
reads2.5K_n2_clean = reads2.5K_n2[!outliers]
reads2.5K_t2_clean = reads2.5K_t2[!outliers]
GC2.5K_clean = GC2.5K[!outliers]
```



### Spatial Distribution of Normative vs Tumor Reads
```{r}
par(mfcol =c(2,1),mar =c(1,1,1,1))
set.seed(50)
samp1 = sample(length(reads2.5K_n2),5000)

plot(GC2.5K[samp1],reads2.5K_n2[samp1],ylim = c(0,400),xlim = c(0.2,.75), cex = 0.5, pch=20)
plot(GC2.5K[samp1],reads2.5K_t2[samp1],ylim = c(0,400),xlim = c(0.2,.75),cex = 0.5, pch=20)

```

### Learn parameters from chromosome 1

```{r}
l_2n = length(reads2.5K_n2)
l_2t = length(reads2.5K_t2)
GC=GC2.5K[1:l_2n]

```

### Fitting f(GC) for Healthy Sample

```{r}


par(mfcol = c(1,1))
plot(GC2.5K[samp1],reads2.5K_n2[samp1],ylim = c(0,600),xlim = c(0.2,.75), cex = 0.5, pch=20)

subs_n = reads2.5K_n2>50 & reads2.5K_n2<600
mod_2n = lm(reads2.5K_n2~bs(GC,deg = 3,knots = c(seq(0.25,0.6,0.025),0.65), Boundary.knots = c(min(GC),max(GC))),subset = subs_n)

# regression line
pred_range = seq(0.2,0.75,0.01)
resp_n = predict(mod_2n,list(GC=pred_range))
lines(pred_range, resp_n,col = 4,lw=3)


```


### Fitting f(GC) for Tumor Sample

```{r}
GC=GC2.5K[1:l_2t]
subs_t = reads2.5K_t2>50 & reads2.5K_t2<550
#subs_t = reads2.5K_t2>50 & reads2.5K_t2<500 &  GC>0.45
knots_seq = c(seq(0.25,0.6,0.025),0.65)
mod_2t = lm(reads2.5K_t2~bs(GC,deg = 3,knots = knots_seq),subset = subs_t)

pred_range = seq(0.2,0.75,0.01)
resp_t = predict(mod_2t,list(GC=pred_range))
resp_n = predict(mod_2n,list(GC=pred_range))
```

```{r}

par(mfcol = c(1,1))

plot(GC2.5K[samp1],reads2.5K_t2[samp1],ylim = c(0,600),xlim = c(0.2,.75), cex = 0.5, pch=20)

lines(pred_range, resp_n,col = 4,lw=3)
lines(pred_range, resp_t,col = 6,lw=3)
legend("topright", legend = c("Healthy Sample", "Tumor Sample"), col = c(4, 6), lty = 1, lwd = 2)


```

## One sample corrections (aka only GC & median correction)
```{r}
one_sample_gc_correct = function(samp, preds, eps) {
  one_correct = (samp+eps)/(preds+eps)
  adj_med = 1/median(one_correct)
  return(adj_med * one_correct)
}
```

```{r}
# take maximum with 0
preds1n = pmax(predict(mod_2n,list(GC=GC2.5K)),0)
preds1t = pmax(predict(mod_2t,list(GC=GC2.5K)),0)


# One Sample with espilon, Normative
eps = 10
corrected_2n = one_sample_gc_correct(reads2.5K_n2,preds1n[1:l_2n],eps)
uncorrected_2n = one_sample_gc_correct(reads2.5K_n2,rep(1,length(reads2.5K_n2)),eps)

# One Sample with espilon, Tumor
eps = 10
corrected_2t = one_sample_gc_correct (reads2.5K_t2,preds1t[1:l_2t],eps)
uncorrected_2t = one_sample_gc_correct(reads2.5K_t2,rep(1,length(reads2.5K_t2)),eps)
```

```{r}
par(mfcol = c(2,1),mar = c(0.5,5,2,2))
discontinuous_range = c(5000:6000,15000:16000)
plot(uncorrected_2t[discontinuous_range], 
     main = "GC Correction for Tumor Sample",
     ylab = "Before", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=1000,col=2,lt = 2, lwd = 1.2)

# main_text = "GC Correction for Tumor Sample"
# sub_text = "One-Sample Correction for Tumor Sample"
# mtext(side=3, line=1, cex=1, main_text)
# mtext(side=1, line=1, cex=1, sub_text)

plot(corrected_2t[discontinuous_range], 
     ylab = "After", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=1000,col=2,lt = 2, lwd = 1.2)

plot(uncorrected_2n[discontinuous_range], ylab = "Before", xaxt = "n",
     main = "GC Correction for Healthy Sample",
     ylim = c(0,2.5),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=1000,col=2,lt = 2, lwd = 1.2)
plot(corrected_2n[discontinuous_range], ylab = "After", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=1000,col=2,lt = 2, lwd = 1.2)

plot(1)

```


```{r}
par(mfcol = c(2,1), mar = c(1,5,1,1))

# Plot for Healthy
plot(corrected_2n[discontinuous_range], ylab = "Healthy",xaxt = "n",
     main = "After GC Correction ('One Sample')", 
     ylim = c(0,2), cex = 0.2, pch=20)
abline(h=1, col=4, lwd = 1.5)

# Plot for Tumor
plot(corrected_2t[discontinuous_range], ylab = "Tumor",xaxt = "n",
     ylim = c(0,2), cex = 0.2, pch=20)
abline(h=1, col=4, lwd = 1.5)
abline(v=700,col=2,lt = 2, lwd = 1.2)
abline(v=750,col=2,lt = 2, lwd = 1.2)
plot(1)

```


```{r}
par(mfcol = c(2,1),mar = c(2,2,2,2))
plot(uncorrected_2t[discontinuous_range], main = "What's The Purpose Of This One...?",
     ylim = c(0,3),cex = 0.2,pch=20)
abline(h=1,col=4)
plot(corrected_2n[discontinuous_range],
     ylim = c(0,3),cex = 0.2,pch=20)
abline(h=1,col=4)

```

### Two sample corrections ...
```{r}
two_sample_correct = function(tumor, normal) {
  two_correct = (tumor)/(normal)
  two_correct_aft_med =  two_correct/median(two_correct,na.rm=TRUE)
  return(two_correct_aft_med)    
}
```

### Two sample corrections w/ epsilon
```{r}
two_sample_correct_e = function(tumor, normal,eps) {
  two_correct = (tumor+eps)/(normal+eps)
  two_correct_aft_med = two_correct/median(two_correct,na.rm=TRUE)
  return(two_correct_aft_med)
}

```


```{r}
two_sample_w_gc = two_sample_correct_e(corrected_2t,corrected_2n,0.1)
two_sample_wout_gc = two_sample_correct_e(uncorrected_2t,uncorrected_2n,0.1)

two_sample_wout_gc = two_sample_correct(uncorrected_2t,uncorrected_2n)

par(mfcol = c(3,1),mar = c(5,2,5,2))
plot(two_sample_w_gc[discontinuous_range], xaxt = "n", 
     xlab = "", main = "Three Fixes: Median, GC, Two-Sample w/ Epsilon",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=1000,col=2,lt = 2, lwd = 1.2)

plot(two_sample_wout_gc[discontinuous_range],xaxt = "n",
     xlab = "", main = "Median + Two-Sample w/ Epsilon",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=1000,col=2,lt = 2, lwd = 1.2)

plot(two_sample_wout_gc[discontinuous_range],xaxt = "n",
     xlab = "Reads Count per Bin Location (5K)",
     main = "Median + Two-Sample (No Epsilon)",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=1000,col=2,lt = 2, lwd = 1.2)

plot(1)
```

```{r}
trim = function(x,l,u){ pmax(pmin(x, u), l) }
b_range= seq(0,3,0.05)
#use_range = 1:49000
use_range = discontinuous_range

par(mfrow = c(2,3),mar = c(2,5,2,0))

# ONLY MEDIAN FIX
trim_med_e_2n = trim(uncorrected_2n[use_range],0.3,3)
hist(trim(uncorrected_2n[use_range],0.3,3),
     ylim = c(0,2.5), ylab = "Median Fix Only",
     breaks = b_range,freq = FALSE, main = "Normative Sample")
abline(v=1,col=4, lwd = 1.5)
abline(v=mean(trim_med_e_2n),col=2,lt = 2, lwd = 1.2)

trim_med_e_2t = trim(uncorrected_2t[use_range],0.3,3)
hist(trim(uncorrected_2t[use_range],0.3,3),
     ylim = c(0,2.5), breaks = b_range, freq = FALSE, 
     ylab = "", main = "Tumor Sample")
abline(v=1,col=4, lwd = 1.5)
abline(v=mean(trim_med_e_2t),col=2,lt = 2, lwd = 1.2)

trim_med_e_both = trim(two_sample_wout_gc[use_range],0.3,3)
hist(trim(two_sample_wout_gc[use_range],0.3,3),
     ylim = c(0,2.5), breaks = b_range, freq = FALSE, 
     ylab = "", main = "Both Samples")
abline(v=1,col=4, lwd = 1.5)
abline(v=mean(trim_med_e_both),col=2,lt = 2, lwd = 1.2)


# MEDIAN + GC FIX
trim_med_gc_e_2n = trim(corrected_2n[use_range],0.3,3)
hist(trim_med_gc_e_2n,
     ylim = c(0.0,4.0), ylab = "Median + GC Fix",
     breaks = b_range,freq = FALSE,main = "")
abline(v=1,col=4)
abline(v=mean(trim_med_gc_e_2n),col=2,lt = 2, lwd = 1.2)

trim_med_gc_e_2t = trim(corrected_2t[use_range],0.3,3)
hist(trim_med_gc_e_2t,
     ylim = c(0.0,4.0), breaks = b_range,freq = FALSE,
     ylab = "", main = "")
abline(v=1,col=4)
abline(v=mean(trim_med_gc_e_2t),col=2,lt = 2, lwd = 1.2)

trim_med_gc_e_both = trim(two_sample_w_gc[use_range],0.3,3)
hist(trim_med_gc_e_both,
     ylim = c(0.0,4.0), breaks = b_range,freq = FALSE, 
     ylab = "", main = "")
abline(v=1,col=4, lwd = 1.5)
abline(v=mean(trim_med_gc_e_both),col=2,lt = 2, lwd = 1.2)

# Add legend
legend(c(3,-4), legend = c("Expected Mean", "Actual Mean"),
       col = c(4, 2), lwd = 3,
       lty = 1, bty = "n")

plot(1)

```

Another interesting region: 

```{r}
range_b = 1000:3001
par(mfcol = c(3,1),mar = c(2,2,2,2))
plot(range_b,two_sample_w_gc[range_b],
     ylim = c(0,3.5),cex = 0.2,pch=20, main = "Two Samp + GC"
       )
abline(h=1,col=4)
plot(range_b,two_sample_wout_gc[range_b], main = "Two Samp",
     ylim = c(0,3.5),cex = 0.2,pch=20)
abline(h=1,col=4)
plot(range_b,corrected_2t[range_b],main = "GC (aka One Samp)",
     ylim = c(0,3.5),cex = 0.2,pch=20)
abline(h=1,col=4)


```


If Y is small and f is small, the effect of adding an epsilon will move it to 1.
