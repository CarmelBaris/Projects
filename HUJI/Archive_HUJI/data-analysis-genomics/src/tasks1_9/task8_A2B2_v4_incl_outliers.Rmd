---
title: "Lab Task 8"
author: "Group 6"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output:
  html_document:
    code_folding: show
editor_options: 
  markdown: 
    wrap: sentence
---

Group members:

- Shawn Yakir , 315714980,  shawn.yakir@mail.huji.ac.il
- Sarah Levitz, 324673623, sarah.levitz@mail.huji.ac.il
- Carmel Baris, 318455276, carmel.baris@mail.huji.ac.il 

### Clean the environment
```{r clean}
rm(list = ls())
```

### Libraries used

```{r libraries}
library('splines')
library('scales')
```


### Paths
```{r paths}
path = "~/Carmel/RProjects/Lab_Benjamini/data"
# path = "/Users/alevi/Downloads/"
 # path = "\\Users\\shawn\\Desktop\\"
```


### Functions

Correcting functions:

```{r correcting_funcs}

### Median correction
fix_med = function(samp) {
  return(samp/median(samp,na.rm=TRUE))
}

### One sample correction
fix_gc_e = function(samp, preds, eps=0) {
  return((samp+eps)/(preds+eps))
}


### Two sample correction
fix_2samp_e = function(tumor, healthy, eps=0) {
  return((tumor+eps)/(healthy+eps))
}

```



### Load data
```{r dat}
load(sprintf("%s/reads_100_A2.rda",path))
load(sprintf("%s/reads_100_B2.rda",path))
load(sprintf("%s/GC_100.rda",path))
```

### Binning
```{r binning}
binsize = 25

chr2t_mat = matrix(reads_100_A2, nr = binsize)
chr2n_mat = matrix(reads_100_B2, nr = binsize)
GC_100=GC_100[1: (length(reads_100_A2)) ]
gc_mat = matrix(GC_100,nr=binsize)

reads_tumor = colSums(chr2t_mat)
reads_healthy = colSums(chr2n_mat)
GC_percent = colMeans(gc_mat)

```


### Spatial Distribution of Healthy vs Tumor Reads
```{r plot_spatial}
# Plot the data
set.seed(50)
samp1 = sample(length(reads_healthy), 10000)

plot(GC_percent[samp1], reads_tumor[samp1], cex = 0.4, pch = 20, 
     main = "Tumor Sample", ylab = "Fragments Per Bin", xlab = "GC Content",
     ylim = c(0, 400), xlim = c(0.2, 0.75))
```


### Learn parameters from chromosome 1

```{r reg_lm}
len_h = length(reads_healthy)
len_t = length(reads_tumor)

myknots = c(0.415, 0.45, 0.54)
pred_range = seq(0.2,0.75,0.01)

GC=GC_percent[1:len_h]

reg_healthy_lm = lm(reads_healthy~GC,subset = reads_healthy>50 & reads_healthy<350)
reg_tumor_lm = lm(reads_tumor~GC,subset = reads_tumor>50 & reads_tumor<400)

resp_healthy_lm = predict(reg_healthy_lm,list(GC=pred_range))
preds_healthy_lm = predict(reg_healthy_lm,list(GC=GC_percent))

response_tumor_lm = predict(reg_tumor_lm,list(GC=pred_range))
preds_tumor_lm = predict(reg_tumor_lm,list(GC=GC_percent))

plot(GC_percent[samp1], reads_tumor[samp1], cex = 0.4, pch = 20, 
     main = "Tumor Sample", ylab = "Fragments Per Bin", xlab = "GC Content",
     ylim = c(0, 400), xlim = c(0.2, 0.75))
lines(pred_range, response_tumor_lm,col = "maroon",lw=3)


```

```{r reg_bs}
len_h = length(reads_healthy)
len_t = length(reads_tumor)

myknots = c(0.36, 0.415, 0.45, 0.54)
pred_range = seq(0.2,0.75,0.01)

GC=GC_percent[1:len_h]

reg_healthy_bs = lm(reads_healthy~bs(GC, degree = 3),subset = reads_healthy>50 & reads_healthy<350 )
reg_tumor_bs = lm(reads_tumor~bs(GC, degree = 3),subset = (reads_tumor>50)&(reads_tumor<400))

resp_healthy_bs = predict(reg_healthy_bs,list(GC=pred_range))
preds_healthy_bs = predict(reg_healthy_bs,list(GC=GC_percent))

response_tumor_bs = predict(reg_tumor_bs,list(GC=pred_range))
preds_tumor_bs = predict(reg_tumor_bs,list(GC=GC_percent))

plot(GC_percent[samp1], reads_tumor[samp1], cex = 0.4, pch = 20, col = rgb(0.2,0.2,0.2,0.8),
     main = "Tumor Sample", ylab = "Fragments Per Bin", xlab = "GC Content",
     ylim = c(0, 400), xlim = c(0.2, 0.75))
lines(pred_range, response_tumor_bs,col = "darkturquoise",lw=3)


```

### Variance Decompisition

We'll start with a breakdown of the variance in the healthy sample after filtering out the outliers and after correcting the median.

```{r res_2n}
# Fit B-spline Model
len_h = length(reads_healthy)
GC = GC_percent[1:len_h]
residuals_2n = reads_healthy - preds_healthy_bs
```

```{r var_decompisition}
### Median Correction
fixed_2n = reads_healthy / median(reads_healthy)

### Variance Decomposition
total_var = var(reads_healthy)
poiss_var = mean(reads_healthy)/(median(reads_healthy)^2)
gc_variance = var(preds_healthy_bs)
unexplained_variance = total_var-poiss_var - gc_variance

### Percentage of Variance
percentage_poisson = (poiss_var / total_var) * 100
percentage_gc = (gc_variance / total_var) * 100
percentage_unexplained = (unexplained_variance / total_var) * 100
```

```{r print_var_decompisition}
### Results
cat("Percentage of variance due to Poisson distribution:", round(percentage_poisson,13), "% < 0.001 %\n")
cat("Percentage of variance due to GC effect: ", round(percentage_gc,2), "%\n")
cat("Percentage of variance unexplained: ", round(percentage_unexplained,2), "%\n")

```

```{r med_fix}
fixed_2n_gc_med_eps = fix_gc_e(reads_healthy, preds_healthy_bs[1:len_h])
unfixed_2n_gc_med_eps = fix_med(reads_healthy)

fixed_2t_gc_med_eps = fix_gc_e (reads_tumor,preds_tumor_bs[1:len_t])
unfixed_2t_gc_med_eps = (reads_tumor)/median(reads_tumor) 

```


```{r plot_tn_stacked}
range_a = (25000000/2500):(30000000/2500)

par(mfcol = c(4,1),mar = c(2,5,2,2))

plot(unfixed_2n_gc_med_eps[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Healthy 2", main = "Before Median Fix")
abline(h=1,col=4)
plot(unfixed_2t_gc_med_eps[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Tumor 2")
abline(h=1,col=4)

plot(fixed_2n_gc_med_eps[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Healthy 2", main = "After")
abline(h=1,col=4)
plot(fixed_2t_gc_med_eps[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Tumor 2")
abline(h=1,col=4)

```




### Part 2 Q1: 

```{r fit_bs}
# Fit B-spline Regression Models
GC_healthy = GC_percent
mod_healthy = lm(reads_healthy ~ bs(GC_healthy, degree = 3))
pred_healthy = predict(mod_healthy, list(GC_healthy = GC_healthy))

# Tumor Sample
reads_tumor = reads_tumor[1:len_h]  # Ensure tumor data matches in length
mod_tumor = lm(reads_tumor ~ bs(GC_healthy, degree = 3))
pred_tumor = predict(mod_tumor, list(GC_healthy = GC_healthy))

```

```{r pred_range}
# Define the range for predictions
pred_range = seq(0.2, 0.75, 0.01)

# Predict values over the range for both models
preds_healthy_bs = predict(mod_healthy, newdata = data.frame(GC_healthy = pred_range))
preds_tumor_bs = predict(mod_tumor, newdata = data.frame(GC_healthy = pred_range))

```

### One sample corrections (aka only GC & median correction)
```{r one_samp_gc}
one_sample_gc_correct = function(samp, preds, eps) {
  one_correct = (samp+eps)/(preds+eps)
  adj_med = 1/median(one_correct)
  return(adj_med * one_correct)
}
```

```{r pmax}
# take maximum with 0
preds1n = pmax(predict(reg_healthy_bs,list(GC=GC_percent)),0)
preds1t = pmax(predict(reg_tumor_bs,list(GC=GC_percent)),0)


# One Sample with espilon, Normative
eps = 0.1

fixed_2n_gc_med_eps = one_sample_gc_correct(reads_healthy, preds1n[1:len_h], eps)
unfixed_2n_gc_med_eps = one_sample_gc_correct(reads_healthy, rep(1,len_h), eps)

# One Sample with espilon, Tumor
eps = 0.1
fixed_2t_gc_med_eps = one_sample_gc_correct (reads_tumor,preds1t[1:len_t],eps)
unfixed_2t_gc_med_eps = one_sample_gc_correct(reads_tumor,rep(1,len_t),eps)
```

```{r discontinuous_range}
par(mfcol = c(2,1),mar = c(0.5,5,2,2))
loc2bin = function(v, bin_size){
  return((v*1000000)/bin_size)}

bins = loc2bin(c(25,35,75,80),2500)
discontinuous_range = c(bins[1]:bins[2], bins[3]:bins[4])
# discontinuous_range = c(10000:14000,15000:16000)
```


```{r plot_gc_fix_tumor}
plot(unfixed_2t_gc_med_eps[discontinuous_range], 
     main = "GC Correction for Tumor Sample",
     ylab = "Before", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)

# main_text = "GC Correction for Tumor Sample"
# sub_text = "One-Sample Correction for Tumor Sample"
# mtext(side=3, line=1, cex=1, main_text)
# mtext(side=1, line=1, cex=1, sub_text)

plot(fixed_2t_gc_med_eps[discontinuous_range], 
     ylab = "After", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)

plot(unfixed_2n_gc_med_eps[discontinuous_range], ylab = "Before", xaxt = "n",
     main = "GC Correction for Healthy Sample",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)
plot(fixed_2n_gc_med_eps[discontinuous_range], ylab = "After", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)

plot(1)

```


```{r plot_gc_fix_healthy}
par(mfcol = c(2,1), mar = c(1,5,1,1))
# par(mfcol = c(2,1))
# Plot for Healthy
plot(fixed_2n_gc_med_eps[discontinuous_range], ylab = "Healthy", xaxt = "n",
     main = "After GC Correction ('One Sample')", 
     ylim = c(0,2), cex = 0.2, pch=20)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)
# Plot for Tumor
plot(fixed_2t_gc_med_eps[discontinuous_range], ylab = "Tumor", xaxt = "n",
     ylim = c(0,2), cex = 0.2, pch=20)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)
plot(1)

```


### Two sample corrections ...
```{r two_samp}
two_sample_correct = function(tumor, normal) {
  two_correct = (tumor)/(normal)
  two_correct_aft_med =  two_correct/median(two_correct,na.rm=TRUE)
  return(two_correct_aft_med)    
}
```

### Two sample corrections w/ epsilon
```{r two_samp_e}
two_sample_correct_e = function(tumor, normal,eps) {
  two_correct = (tumor+eps)/(normal+eps)
  two_correct_aft_med = two_correct/median(two_correct,na.rm=TRUE)
  return(two_correct_aft_med)
}

```


```{r apply_two_samp}
two_samp_med_gc_eps = two_sample_correct_e(fixed_2t_gc_med_eps,fixed_2n_gc_med_eps,0.1)
two_samp_med_eps = two_sample_correct_e(unfixed_2t_gc_med_eps,unfixed_2n_gc_med_eps,0.1)
two_samp_med = two_sample_correct(unfixed_2t_gc_med_eps,unfixed_2n_gc_med_eps)
```



```{r plot_two_samp}
# par(mfcol = c(2,1),mar = c(0.5,5,2,2))
par(mfcol = c(2,1),mar = c(0.5,5,2,2))
loc2bin = function(v, bin_size){
  return((v*1000000)/bin_size)}

bins = loc2bin(c(25,35,75,80),2500)
discontinuous_range = c(bins[1]:bins[2], bins[3]:bins[4])
# discontinuous_range = c(10000:14000,15000:16000)


## one sample median + GC correction
plot(unfixed_2t_gc_med_eps[discontinuous_range], ylab = "Before", xaxt = "n",
     main = "GC Correction for Tumor Sample",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)
plot(fixed_2t_gc_med_eps[discontinuous_range], ylab = "After", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)



## two sample median + GC correction
plot(fixed_2t_gc_med_eps[discontinuous_range], ylab = "Med+GC OneSamp (Tumor)", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)

plot(two_samp_med_gc_eps[discontinuous_range], ylab = "Med+GC+Epsilon TwoSamp (Tumor)", xaxt = "n",
     ylim = c(0,2.5),cex = 0.2,pch=20, xlim = c(0,6000))
abline(h=1,col=4, lwd = 1.5)
abline(v=4000,col=6,lt = 2, lwd = 1.2)

plot(1)

```


```{r plot_fixes}
# par(mfcol = c(2,1), mar = c(1,5,1,1))
# par(mfcol = c(2,1))
# Plot for Healthy
plot(fixed_2n_gc_med_eps[discontinuous_range], ylab = "Healthy", xaxt = "n",
     main = "After GC Correction ('One Sample')", 
     ylim = c(0,2), cex = 0.2, pch=20)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)
# Plot for Tumor
plot(fixed_2t_gc_med_eps[discontinuous_range], ylab = "Tumor", xaxt = "n",
     ylim = c(0,2), cex = 0.2, pch=20)
abline(h=1, col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)



####
####

plot(two_samp_med_gc_eps[discontinuous_range], xaxt = "n", 
     xlab = "", main = "Three Fixes: Median, GC, Two-Sample w/ Epsilon",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_eps[discontinuous_range],xaxt = "n",
     xlab = "", main = "Median + Two-Sample w/ Epsilon",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_eps[discontinuous_range],xaxt = "n",
     xlab = "Both Samples, Reads Count per Bin Location (2.5K)",
     main = "Median + Two-Sample (No Epsilon)",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)
plot(1)

```

```{r plot_two_samp_fixes}
par(mfcol = c(3,1),mar = c(5,2,5,2))
plot(two_samp_med_gc_eps[discontinuous_range], xaxt = "n", 
     xlab = "", main = "Three Fixes: Median, GC, Two-Sample w/ Epsilon",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_eps[discontinuous_range],xaxt = "n",
     xlab = "", main = "Median + Two-Sample w/ Epsilon",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(two_samp_med_eps[discontinuous_range],xaxt = "n",
     xlab = "Both Samples, Reads Count per Bin Location (2.5K)",
     main = "Median + Two-Sample (No Epsilon)",
     ylim = c(0,2),cex = 0.2,pch=20)
abline(h=1,col=4, lwd = 1.5)
abline(v=c(1000,1200,4000),col=c(5,5,6), lt=c(1,1,2), lwd = 1.2)

plot(1)
```



