---
title: "Lab Task 6"
author: "Group 6"
date: Sys.Date()
output:
  html_document:
    code_folding: show
editor_options: 
  markdown: 
    wrap: sentence
---

Group members:

- Shawn Yakir , 315714980, shawnyakir@gmail.com
- Sarah Levitz, 324673623, sarah.levitz@mail.huji.ac.il
- Carmel Baris, 318455276, carmel.baris@mail.huji.ac.il 


### Clean the environment
```{r clean}
rm(list = ls())
```

### Libraries used

```{r libraries}
library('splines')
```


### Paths
```{r paths}
dir_name = "C:/Users/user/Documents/Carmel/Projects/HUJI/Archive_HUJI/data-analysis-genomics/data/"
#dir_name = "/Users/alevi/Downloads/"
#dir_name = "\\Users\\shawn\\Desktop\\"
```


```{r helpers}
helpers_file = file.path(dir_name, "help_funcs.R")
source(helpers_file)
helpers = list(loadRData = loadRData)
```


### Data
```{r dat}
# Create data file
# source("C:/Users/user/Documents/Carmel/Projects/HUJI/Archive_HUJI/data-analysis-genomics/data/data_prep_v1.R", echo=TRUE)

# Load data file
reads_file_20K = file.path(dir_name, "reads_gc_20K_cln.rda")
reads_gc_20K = helpers$loadRData(reads_file_20K)
GC_20K = reads_gc_20K$GC_20K
reads_20K = reads_gc_20K$reads_20K
```


## Introduction 

This week we began to estimate the number of genomic copies, for a given bin. \n
Our original assumption is that this estimate should be proportional to the coverage, i.e. the number of reads in that bin. \n
So far we have learned that the distribution of $Y_k$, the coverage of bin $K$, depends on the GC content in that bin: $Y_K \sim f(GC_K) + \mathcal{E}_K$. \n
The estimated (predicted) coverage in bin $K$ is given by the following formula: $\hat{Y}_K \sim \hat{f}(GC_K) \ \cdot \ \eta_{_K}$

is equivalent to the following conditional distribution: $\hat{E}\big[ Y_K|X_K=x_k \big]$. We estimated this distribution using splines regression: $\hat{f}(GC)_K = E[Y_K | X_j \in Bin_K]$



## Fitting bspline regression
```{r fit}
f = function(X, Y, degree=3, knots=c(0.415, 0.45, 0.54), sub_filter=NA) {
  lm(Y ~ bs(X, degree = degree, knots = knots, Boundary.knots = c(min(X), max(X))), subset = sub_filter)
}


```


## Q1. Estimating Number of copies 

$$\hat{a}_K = \frac{Y_K}{\hat{f}(GC_K)} \cdot \frac{1}{\mathcal{E}_K}$$

```{r copies}

estimate_num_copies <- function(Y, X, Yhat, varNoise) {
  copies_est <- Y / Yhat
  
  # Apply noise if varNoise is provided
  if (!is.null(varNoise) && varNoise > 0) {
    noise = exp(rnorm(length(Y), mean = 0, sd = sqrt(varNoise)))
    copies_est = copies_est / noise
  }
  
  return(copies_est)
}

```


## Q2.a. Estimating for Specific Region

```{r wet_run}

# Select an area of 1000 consecutive cells
start_idx = 2000  # You can choose any starting index
end_idx = start_idx + 999
selected_GC_20K = GC_20K[start_idx:end_idx]
selected_reads_20K = reads_20K[start_idx:end_idx]
# Plot the spatial distribution to identify the selected region
plot(reads_20K)
abline(v=c(start_idx, end_idx), col="indianred2")
plot(GC_20K, col="gold")

myknots = c(0.415, 0.45, 0.54)

est_f_select = f(X = selected_GC_20K, Y = selected_reads_20K, degree = 3, knots = myknots)
pred_reads_20K = est_f_select$fitted.values
tiny_v = 0.0001

est_a = estimate_num_copies(Y=selected_reads_20K, X=selected_GC_20K, Yhat=pred_reads_20K, varNoise=tiny_v)
summary(est_a)

par(mfrow = c(2,1))

# Show the marginal distribution
hist(est_a, main = "Marginal Distribution of Estimated Num of Copies", xlab = "Number of Copies (Est.)")

# Show the genome-wide distribution
plot(est_a, main = "Spatial Distribution of Estimated Num of Copies", 
     xlab = "Chromosomal Index", ylab = "Number of Copies (Est.)",
     ylim = c(0,2), col=rgb(0,0,0,0.75))


# Color outliers in genome-wide distribution
upr_lim = 1.5
lwr_lim = 0.5
suspected = (est_a > upr_lim | est_a < lwr_lim)
abline(h=c(lwr_lim,upr_lim), lwd=1.3, lty=44, col="indianred2")
abline(h=1, lwd=2.5, col="royalblue")

par(mfrow = c(1,1))

```

## Q2.b. Measuring the Quality of the Estimator

We will compare two estimations, each with a different estimated sample variance of the errors.

```{r}

cat("Variance of noise/error:", sprintf("%.0004f", tiny_v), "\n")
cat("Avg num of copies (est):", round(mean(est_a),4), "\n")
mad_1 = mean(abs(est_a - round(mean(est_a),4)))
cat("Mean Absolute Deviation:", round(mad_1,4), "\n")

cat("\n")

small_v = 0.2
est_a0 = estimate_num_copies(Y=selected_reads_20K, X=selected_GC_20K, Yhat=pred_reads_20K, varNoise=small_v)

cat("Variance of noise/error:", sprintf("%.3f", small_v), "\n")
cat("Avg num of copies (est):", round(mean(est_a0),3), "\n")
mad1 = mean(abs(est_a0 - round(mean(est_a0),4)))
cat("Mean Absolute Deviation:", round(mad1,3), "\n")


```

## Q3. Evaluating the Quality of the Estimator

1. **Potential Bias:**
   - The histogram of predicted read counts shows a concentration between 1400 and 2000, with a peak around 1800. 
   - The slight right skew indicates a tendency to over-predict read counts more frequently than under-predicting, suggesting a potential bias in the estimator.

2. **Variance and Limits of the Selected Region:**
   - The variance is notably higher at the edges of the distribution, indicating greater uncertainty in these regions.
   - This increased variability reduces the reliability of the estimator at the distribution’s extremities.

3. **Sensitivity to Outliers:**
   - Abnormal values in GC-content or Coverage can significantly skew the estimates, especially in small samples.
   - Such outliers may lead to significant overestimation or underestimation.

4. **Effect of Parameters η and v:**
   - A high value of \( v \) can lead to higher variability in the estimates.
   - Conversely, too low a value of \( v \) may result in an overly simplistic model.
   - Assuming a normal distribution for \( η \) might be inaccurate, potentially affecting the estimator’s accuracy.

5. **Model Assumptions:**
   - The model’s assumptions, such as the Poisson distribution and the relationship between GC content and read counts, might be inaccurate. This can lead to systematic biases, as previously discussed.

6. **Sensitivity to the Estimation Quality of \( f(GC) \):**
   - Inaccurate estimation of \( f(GC) \) can introduce systematic biases, affecting the overall reliability of the estimator.

## Q4. Estimating variance of the noise

```{r}
estimate_v = function(Y, GC, Yhat) {
  
  # Calculate ratio
  ratio = Y / Yhat
  
  # Remove infinite and zero values
  ratio = ratio[is.finite(ratio) & ratio > 0]
  
  # Estimate v as the sample variance of the log of this ratio
  v_estimate = var(log(ratio))
  return(v_estimate)
}

est_f = f(X = GC_20K, Y = reads_20K, degree = 3, knots = myknots)
pred_reads_20K = est_f$fitted.values

est_v = estimate_v(reads_20K, GC_20K, pred_reads_20K)
print(round(est_v,2))

```


## Conclusions
* The estimator generally performs well with most estimated copy numbers centered around the expected value of 1.
* There is moderate noise in the data, and the estimator's performance degrades as noise increases.
* Outliers and regions with significant deviations from the expected number of copies need further investigation to understand if they are due to biological variations or noise.
* Fine-tuning the model parameters is essential for improving the estimator's accuracy and robustness.


