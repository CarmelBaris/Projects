---
title: "Lab Task 7"
author: "Group 6"
date: Sys.Date()
output:
  html_document:
    code_folding: show
editor_options: 
  markdown: 
    wrap: sentence
---

Group members:

- Shawn Yakir , 315714980,  shawn.yakir@mail.huji.ac.il
- Sarah Levitz, 324673623, sarah.levitz@mail.huji.ac.il
- Carmel Baris, 318455276, carmel.baris@mail.huji.ac.il 

### Clean the environment
```{r clean}
rm(list = ls())
```

### Libraries used

```{r libraries}
library('splines')
library('scales')
```


### Paths
```{r paths}
path = "~/Carmel/RProjects/Lab_Benjamini/data"
# path = "/Users/alevi/Downloads/"
#path = "\\Users\\shawn\\Desktop\\"
```


### Helper functions
```{r helpers}
helpers_file = file.path(path, "help_funcs.R")
source(helpers_file)
helpers = list(loadRData = loadRData, binReads = binReads)
```


### Load data
```{r dat}
load(sprintf("%s/reads_100_A2.rda",path))
load(sprintf("%s/reads_100_B2.rda",path))
load(sprintf("%s/GC_100.rda",path))
GC_100=GC_100[1: (length(reads_100_A2)) ]
```

### Binning
```{r binning}
binsize = 25
chr2t_mat = matrix(reads_100_A2, nr = binsize)
# chr2t_mat[,1:2]
# reads_100_A2[1:2]
reads2.5K_t2 = colSums(chr2t_mat)

chr2n_mat = matrix(reads_100_B2, nr = binsize)
# chr2n_mat[,1:2]
# reads_100_B2[1:2]
reads2.5K_n2 = colSums(chr2n_mat)

gc_mat = matrix(GC_100,nr=binsize)
GC2.5K = colMeans(gc_mat)
```


### Outliers
```{r outliers}
# outliers of gc percent per bin
zeros_GC = GC2.5K == 0 #bins w/o GC content
# small_GC = GC2.5K <= 0.3 & GC2.5K > 0 #low-GC content bins (<30%)
# valid_GC = !(zeros_GC | small_GC) #bins w/ at least 30% GC content

# identify outliers of reads count per bin
z_scores_n2 = (reads2.5K_n2 - mean(reads2.5K_n2)) / sd(reads2.5K_n2)
z_scores_t2 = (reads2.5K_t2 - mean(reads2.5K_t2)) / sd(reads2.5K_t2)
xtreme_reads_n2 = abs(z_scores_n2) > 3
xtreme_reads_t2 = abs(z_scores_t2) > 3

# create new variables without outliers
outliers = (zeros_GC | xtreme_reads_t2 | xtreme_reads_n2)
outliers = (outliers | (reads2.5K_t2<0.05) | (reads2.5K_n2<0.05))
reads2.5K_n2_clean = reads2.5K_n2[!outliers]
reads2.5K_t2_clean = reads2.5K_t2[!outliers]
GC2.5K_clean = GC2.5K[!outliers]
```

### Fitting bspline regression
```{r fit}
create_est_f = function(X, Y, deg, knots) {
  lknot = min(X)
  rknot = max(X)
  lm(Y ~ bs(X, degree = deg, knots = knots, Boundary.knots = c(lknot, rknot)))
}

```



```{r normalizing}
# Use the rescale function from the scales package
reads2.5K_n2_normalized = scales::rescale(reads2.5K_n2_clean, to = c(0, 100))
reads2.5K_t2_normalized = scales::rescale(reads2.5K_t2_clean, to = c(0, 100))
```

```{r}
# Plot the normalized data
set.seed(50)
samp1 = sample(length(reads2.5K_n2), 10000)
# Plot adjacent
par(mfcol = c(2, 1), mar = c(1, 5, 1, 1))
plot(GC2.5K_clean[samp1], reads2.5K_n2_normalized[samp1], cex = 0.4, pch = 20, ylab = "Healthy 2", ylim = c(1.5, 35), xlim = c(0.2, 0.75))
plot(GC2.5K_clean[samp1], reads2.5K_t2_normalized[samp1], cex = 0.4, pch = 20, ylab = "Tumor 2", ylim = c(0, 35), xlim = c(0.2, 0.75))
```


## Learn parameters from chromosome 1

```{r}
l_2n = length(reads2.5K_n2_normalized)
l_2t = length(reads2.5K_t2_normalized)

myknots = c(0.415, 0.45, 0.54)

GC=GC2.5K_clean[1:l_2n]

mod_2n = lm(reads2.5K_n2_normalized~bs(GC, degree = 3),subset = reads2.5K_n2_normalized>1.5 & reads2.5K_n2_normalized<35 )

pred_range = seq(0.2,0.75,0.01)
resp_n = predict(mod_2n,list(GC=pred_range))
preds2n = predict(mod_2n,list(GC=GC2.5K_clean))

par(mfcol = c(1,1),mar = c(3,5,3,3))
plot(GC2.5K_clean[samp1],reads2.5K_n2_normalized[samp1],ylim = c(0,35),xlim = c(0.2,.75), cex = 0.5, pch=20, main = "Healthy 2")
lines(pred_range, resp_n,col = 4,lw=3)
lines(pred_range, resp_n,col = 4,lw=3)

```


```{r}
GC=GC2.5K_clean[1:l_2t]
mod_2t = lm(reads2.5K_t2_normalized~bs(GC, degree = 3),subset = (reads2.5K_t2_normalized>1.5)&(reads2.5K_t2_normalized<40))

pred_range = seq(0.2,0.75,0.01)
resp_t = predict(mod_2t,list(GC=pred_range))
preds2t = predict(mod_2t,list(GC=GC2.5K_clean))

par(mfcol = c(1,1),mar = c(3,3,3,3))
plot(GC2.5K_clean[samp1],reads2.5K_t2_normalized[samp1],ylim = c(0,35),xlim = c(0.2,.75), cex = 0.5, pch=20, main = "Tumor 2")
lines(pred_range, resp_t,col = 2,lw=3)
lines(pred_range, resp_n,col = 4,lw=3)
```


## One sample corrections
```{r func_fix}
one_sample_correct = function(samp, preds) {
  one_correct = (samp)/(preds)
  return(one_correct)
}
```

```{r med_fix}
corrected_2n = one_sample_correct (reads2.5K_n2_normalized,preds2n[1:l_2n])
uncorrected_2n = (reads2.5K_n2_normalized)/median(reads2.5K_n2_normalized) 

corrected_2t = one_sample_correct (reads2.5K_t2_normalized,preds2t[1:l_2t])
uncorrected_2t = (reads2.5K_t2_normalized)/median(reads2.5K_t2_normalized) 

```


```{r plot_tn_stacked}
range_a = 5000:6000

par(mfcol = c(4,1),mar = c(2,5,2,2))

plot(uncorrected_2n[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Healthy 2", main = "Before Median Fix")
abline(h=1,col=4)
plot(uncorrected_2t[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Tumor 2")
abline(h=1,col=4)

plot(corrected_2n[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Healthy 2", main = "Corrected")
abline(h=1,col=4)
plot(corrected_2t[range_a], ylim = c(0,2.5), cex = 0.5, pch=20, ylab = "Tumor 2")
abline(h=1,col=4)

```


### Part 1 Q1: 

We'll start with a breakdown of the variance in the healthy sample after filtering out the outliers and after correcting the median.

```{r}
# Fit B-spline Model
l_2n = length(reads2.5K_n2_normalized)
GC = GC2.5K_clean[1:l_2n]
residuals_2n = reads2.5K_n2_normalized - preds2n
```

```{r}
### Median Correction
fixed_2n = reads2.5K_n2_normalized / median(reads2.5K_n2_normalized)

### Variance Decomposition
total_variance = var(reads2.5K_n2_normalized)
poisson_variance = mean(reads2.5K_n2_normalized)/(median(reads2.5K_n2_normalized)^2)
gc_variance = var(preds2n)
unexplained_variance = total_variance-poisson_variance-gc_variance

### Percentage of Variance
percentage_poisson = (poisson_variance / total_variance) * 100
percentage_gc = (gc_variance / total_variance) * 100
percentage_unexplained = (unexplained_variance / total_variance) * 100
```

```{r}
### Results
cat("Percentage of variance due to Poisson distribution: ", percentage_poisson, "%\n")
cat("Percentage of variance due to GC effect: ", percentage_gc, "%\n")
cat("Percentage of variance unexplained: ", percentage_unexplained, "%\n")

```

### Part 2 Q1: 

```{r}
# Fit B-spline Regression Models
GC_healthy = GC2.5K_clean
mod_healthy = lm(reads2.5K_n2_clean ~ bs(GC_healthy, degree = 3))
pred_healthy = predict(mod_healthy, list(GC_healthy = GC_healthy))

# Tumor Sample
reads2.5K_t2_clean = reads2.5K_t2_clean[1:l_2n]  # Ensure tumor data matches in length
mod_tumor = lm(reads2.5K_t2_clean ~ bs(GC_healthy, degree = 3))
pred_tumor = predict(mod_tumor, list(GC_healthy = GC_healthy))

```

```{r}
# Define the range for predictions
pred_range = seq(0.2, 0.75, 0.01)

# Predict values over the range for both models
preds_healthy = predict(mod_healthy, newdata = data.frame(GC_healthy = pred_range))
preds_tumor = predict(mod_tumor, newdata = data.frame(GC_healthy = pred_range))

```

```{r}
# Combined Plot
par(mfcol = c(1, 1), mar = c(5, 5, 4, 2))

# Plot the data points first
plot(GC_healthy, reads2.5K_n2_clean, col = 'blue', pch = 20, cex = 0.5, ylab = "Normalized Reads", xlab = "GC Content", main = "Healthy vs Tumor Sample")
points(GC_healthy, reads2.5K_t2_clean, col = 'red', pch = 20, cex = 0.5)

# Add the regression lines on top
lines(pred_range, preds_healthy, col = 'darkblue', lwd = 2)
lines(pred_range, preds_tumor, col = 'darkred', lwd = 2)

# Add legend
legend("topright", legend = c("Healthy Sample", "Tumor Sample"), col = c("blue", "red"), lty = 1, lwd = 2, pch = 20)

```

### Part 2 Q2:
```{r}
# Extract the specified ranges
reads_100_n2_range = reads2.5K_n2_clean[10000:12000]
reads_100_t2_range = reads2.5K_t2_clean[10000:12000]
GC_100_range = GC_100[10000:12000]

# Ensure the lengths of the ranges are a multiple of binsize
trim_length = length(reads_100_t2_range) - (length(reads_100_t2_range) %% binsize)
reads_100_t2_trimmed = reads_100_t2_range[1:trim_length]
reads_100_n2_trimmed = reads_100_n2_range[1:trim_length]
GC_100_trimmed = GC_100_range[1:trim_length]

# Create the matrices
chr2t_mat = matrix(reads_100_t2_trimmed, nrow = binsize)
reads2.5K_t2 = colSums(chr2t_mat)

chr2n_mat = matrix(reads_100_n2_trimmed, nrow = binsize)
reads2.5K_n2 = colSums(chr2n_mat)

gc_mat = matrix(GC_100_trimmed, nrow = binsize)
GC2.5K = colMeans(gc_mat)

# Apply median normalization
median_t2 = median(reads2.5K_t2)
median_n2 = median(reads2.5K_n2)

reads2.5K_t2_normalized = reads2.5K_t2 / median_t2
reads2.5K_n2_normalized = reads2.5K_n2 / median_n2

# Create a data frame for the results
results <- data.frame(
  Bin = 1:length(reads2.5K_t2),
  Reads_T2 = reads2.5K_t2,
  Reads_T2_Normalized = reads2.5K_t2_normalized,
  Reads_N2 = reads2.5K_n2,
  Reads_N2_Normalized = reads2.5K_n2_normalized,
  GC_Content = GC2.5K
)

# Print the results to verify
print(results)

# Plot the data
library(ggplot2)

ggplot(results, aes(x = Bin)) +
  geom_line(aes(y = Reads_T2, color = "Reads_T2")) +
  geom_line(aes(y = Reads_T2_Normalized, color = "Reads_T2_Normalized"), linetype = "dashed") +
  geom_line(aes(y = Reads_N2, color = "Reads_N2")) +
  geom_line(aes(y = Reads_N2_Normalized, color = "Reads_N2_Normalized"), linetype = "dashed") +
  geom_line(aes(y = GC_Content * max(Reads_T2), color = "GC_Content"), linetype = "dotted") +
  labs(title = "Read Counts and GC Content Along the Chromosome",
       x = "Bin",
       y = "Read Counts / GC Content") +
  scale_color_manual(values = c("Reads_T2" = "blue", "Reads_T2_Normalized" = "green",
                                "Reads_N2" = "red", "Reads_N2_Normalized" = "purple",
                                "GC_Content" = "orange")) +
  theme_minimal()

```

### Part 2 Q3:
```{r}
# Calculate standardized differences (z-scores)
z_scores_diff = (pred_healthy - pred_tumor) / sd(pred_healthy - pred_tumor)


# Adjust the tolerance values
tolerance_similar = 2  # Increase this value to be more stringent for similarities
tolerance_different = 3  # Increase this value to focus on more significant differences

# Identify similar and different sequences with higher tolerance
similar_sequences = which(abs(z_scores_diff) < tolerance_similar)
different_sequences = which(abs(z_scores_diff) > tolerance_different)

# Function to convert a list of indices to ranges
convert_to_ranges <- function(indices) {
  if (length(indices) == 0) return("")
  ranges <- list()
  start <- indices[1]
  end <- indices[1]
  for (i in 2:length(indices)) {
    if (indices[i] == end + 1) {
      end <- indices[i]
    } else {
      if (start == end) {
        ranges <- append(ranges, as.character(start))
      } else {
        ranges <- append(ranges, paste(start, end, sep = "-"))
      }
      start <- indices[i]
      end <- indices[i]
    }
  }
  if (start == end) {
    ranges <- append(ranges, as.character(start))
  } else {
    ranges <- append(ranges, paste(start, end, sep = "-"))
  }
  return(paste(ranges, collapse = ","))
}

# Convert indices to ranges
similar_sequences_ranges <- convert_to_ranges(similar_sequences)
different_sequences_ranges <- convert_to_ranges(different_sequences)

# Output the ranges of similar and different sequences
cat("Indices of similar sequences:", similar_sequences_ranges, "\n")
cat("Indices of different sequences:", different_sequences_ranges, "\n")

# Combined Plot
par(mfcol = c(1, 1), mar = c(5, 5, 4, 2))

# Plot the data points first
plot(GC_healthy, reads2.5K_n2_clean, col = 'blue', pch = 20, cex = 0.5, ylab = "Normalized Reads", xlab = "GC Content", main = "Healthy vs Tumor Sample")
points(GC_healthy, reads2.5K_t2_clean, col = 'red', pch = 20, cex = 0.5)

# Add the regression lines on top
lines(pred_range, preds_healthy, col = 'darkblue', lwd = 2)
lines(pred_range, preds_tumor, col = 'darkred', lwd = 2)

# Highlight similar and different sequences
points(GC_healthy[similar_sequences], reads2.5K_n2_clean[similar_sequences], col = 'green', pch = 19)
points(GC_healthy[different_sequences], reads2.5K_n2_clean[different_sequences], col = 'purple', pch = 19)

# Add legend
legend("topright", legend = c("Healthy Sample", "Tumor Sample", "Similar Sequences", "Different Sequences"), 
       col = c("blue", "red", "green", "purple"), lty = 1, lwd = 2, pch = 20)

```

There are indeed sequences showing significant differences between the cancerous and healthy samples.


### Part 2 Q4:
```{r}
# Assuming corrected_2n and corrected_2t contain the normalized read counts for healthy and tumor samples
# Define a range for plotting
range_b = 1:length(corrected_2n)  # Adjust range as needed

# Plot Read Counts Along the Chromosome
par(mfcol = c(1, 1), mar = c(5, 5, 4, 2))

# Plot the normalized read counts for healthy and tumor samples
plot(range_b, corrected_2n[range_b], type = 'l', col = 'blue', ylab = "Number of Copies", xlab = "Position", main = "Comparison of Copy Numbers Along the Chromosome")
lines(range_b, corrected_2t[range_b], col = 'red')
legend("topright", legend = c("Healthy Sample", "Cancerous Sample"), col = c("blue", "red"), lty = 1)

# Draw an abline to compare copy numbers
abline(h=1, col="grey", lty=2)
```

